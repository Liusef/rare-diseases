from InstructorEmbedding import INSTRUCTOR
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

documents = [
    "Aarskog syndrome primarily affects males. Affected boys exhibit a characteristic set of facial, skeletal, and genital abnormalities. Clinical signs may vary from person to person (clinical heterogeneity), even within families. Males with Aarskog syndrome often have a rounded face with a broad forehead. Additional characteristic facial features include widely spaced eyes (ocular hypertelorism), drooping (ptosis) of the eyelids, downwardly slanting eyelid folds (palpebral fissures), a small nose with nostrils that are flared forward (anteverted nares), an underdeveloped upper jawbone (maxilliary hypoplasia), and a widow’s peak. Affected individuals may also have an abnormally long groove in the upper lip (philtrum) and a broad nasal bridge. These children may also have a variety of abnormalities affecting the ears and teeth. Ear abnormalities include low-set ears and thickened, “fleshy” earlobes. Dental abnormalities include missing teeth at birth, delayed eruption of teeth, and underdevelopment of the hard outer covering of teeth (enamel hypoplasia). Aarskog syndrome is basically a skeletal dysplasia and affected males develop characteristic malformations of the skeletal system including disproportionate short stature; broad, short hands and feet; short, stubby fingers (brachydactyly) with permanent fixation of the fifth fingers in a bent position (clinodactyly); abnormally extendible finger joints; and wide flat feet with bulbous toes. In addition, affected individuals may have a sunken chest (pectus excavatum), protrusion of portions of the large intestine through an abnormal opening in the muscular lining of the abdominal cavity (inguinal hernia), and a prominent navel (umbilicus). Individuals with Aarskog syndrome may have spinal abnormalities such as incomplete closure of the bones of the spinal column (spina bifida occulta), fusion of the upper bones of the spinal column (cervical vertebrae), and underdevelopment of the “peg-like” projection of the second cervical vertebra (odontoid hypoplasia). Signs that help to make a diagnosis in males with Aarskog syndrome are the genital abnormalities, including a characteristic abnormal fold of skin extending around the base of the penis (“shawl” scrotum) and/or failure of one or both of the testes to descend into the scrotum (cryptorchidism). In addition, the urinary opening (meatus) may be located on the underside of the penis (hypospadias) and the scrotum may appear clefted or divided (bifid scrotum). Intellectual disability has been described in some affected boys but it is not a consistent feature of the disorder. Affected individuals may present with a range of mild learning difficulty and/or behavioral disorders: affected children may exhibit developmental delay during infancy, hyperactivity, attention deficit, impulsivity and opposition. Due to this possible spectrum of characteristics, the condition is also referred to as an ADHD syndromic disorder (MRXS16). Failure to gain weight and grow at the expected rate (failure to thrive) and development of chronic respiratory infections have also been described. An additional spectrum of signs and/or symptoms may occur less frequently, including congenital heart defects; abnormal side-to-side curvature of the spine (scoliosis); additional pairs of ribs; incomplete closure of the roof of the mouth (cleft palate) and/or a vertical groove in the upper lip (cleft lip); mild webbing of the fingers; and a short neck with or without webbing. Additional eye abnormalities may be present including crossed eyes (strabismus), farsightedness (hyperopia), and paralysis of certain eye muscles (ophthalmoplegia). Some patients have been reported to have a tendency to be overweight.",
    "The symptoms of Rabson-Mendenhall syndrome vary greatly from person to person. Some individuals may be affected more severely than others. The disorder can potentially cause life-threatening complications during childhood or adolescence. Affected individuals will not have all of the symptoms listed below. Affected individuals or parents of affected children should talk to their physicians and medical team about their specific case and associated symptoms. Rabson-Mendenhall syndrome may become apparent during the first year of life or early during childhood. Initial symptoms include failure to thrive, abnormalities of the teeth and nails including early eruption of teeth (premature dentition), abnormally large teeth (macrodontia), irregular and crowded teeth, and thickened nails. Individuals with Rabson-Mendenhall syndrome may also have a coarse, prematurely-aged facial appearance with an abnormally prominent jaw (prognathism). Affected individuals also have abnormally large ears, full lips, and a furrowed tongue. Another early symptom of Rabson-Mendenhall syndrome is abnormally increased coloration (hyperpigmentation) and “velvety” thickening (hyperkeratosis) of the skin, particularly of skin fold regions, such as of the neck and groin and under the arms (acanthosis nigricans). Affected individuals may also have abnormally dry skin. Additional symptoms associated with Rabson-Mendenhall syndrome may include abdominal swelling (distension) and abnormal enlargement of the clitoris in females and the penis in males. Affected individuals may experience excessive hair growth (hypertrichosis) and some females may exhibit a male pattern of hair growth (hirsutism). Deficiency or absence of fatty tissue (adipose tissue) may also be present. Some individuals may attain puberty at an abnormally early age (precocious puberty). Short stature is an additional characteristic that may also be observed. Rarely, individuals with Rabson-Mendenhall syndrome may have an abnormally large pineal gland (pineal hyperplasia). The pineal gland is a tiny organ in the brain that secretes melatonin, a hormone that helps to regulate sleep cycles and metabolism and is involved with certain aspects of sexual development. Affected individuals often have altered melatonin secrete, which contributes to the development of certain symptoms associated with Rabson-Mendenhall syndrome. Because individuals with Rabson-Mendenhall syndrome fail to use insulin properly they may experience abnormally high blood sugar levels (hyperglycemia) after eating a meal (postprandial) and abnormally low blood sugar levels (hypoglycemia) when not eating. Along with the high blood sugars after eating and frequent low blood sugars in the fasting state, the blood insulin level will be quite elevated. As children with Rabson-Mendenhall syndrome age they may develop more serious complications including diabetes mellitus, enlarged, cystic ovaries, and risk for dehydration. Diabetes may result in individuals having decreased resistance to life-threatening infections. Another life-threatening complication called ketoacidosis may also occur, secondary to diabetes mellitus. Ketoacidosis is elevated levels of acids in the body accompanied by abnormal accumulation of ketone bodies. (Ketone bodies are chemical substances normally produced by fatty acid metabolism in the liver.) Most individuals with Rabson-Mendenhall syndrome also have abnormalities affecting the kidneys, such as nephrocalcinosis.",
    "In infancy and early childhood, delayed milestones in speech and motor skills are common, as are medical features including low muscle tone (hypotonia), feeding disorders, delayed appearance of teeth, crossed eyes (strabismus) and a twisted neck (torticollis) with flattening on one side of the head. Other physical features can include a skin fold of the upper eyelid covering the inner corner of the eye (epicanthal fold), an abnormally large distance between the eyes (hypertelorism) and an abnormally bend or curved 5th finger (clinodactyly). There are also increased risks for congenital heart defects, kidney malformations and skeletal abnormalities including pes planus, club foot, radioulnar synostosis, cubitus varus (with prominent elbows), scoliosis and kyphosis. Other medical conditions that are more frequent in 48, XXYY syndrome include epilepsy (~15%), tremor (~60% of adults), asthma/allergies (~60%), significant dental problems (~90%), gastrointestinal problems (feeding intolerance, reflux, constipation, eosinophilic esophagitis), joint laxity, sleep apnea, thrombosis (~18%) and type 2 diabetes (~20% in adulthood). Tall stature is another common physical feature that can be more noticeable in adolescence. Small testes (microorchidism) and resulting testicular dysfunction leads to hypergonadotropic hypogonadism (low testosterone levels) that is nearly universal which starts in adolescence and persists throughout the lifetime. Low testosterone levels can be associated with incomplete pubertal development (decreased development of facial and body hair), decreased muscle bulk and strength, fatigue, low endurance and mental health effects such as depression. Testicular dysfunction is also associated with impaired fertility. Undescended testes (cryptorchidism), inguinal hernias, micropenis, and enlargement of breast tissue (gynecomastia) can also be associated, however gynecomastia can be prevented or minimized with appropriate testosterone management starting in adolescence. 48, XXYY syndrome presents with more significant cognitive impairments and behavior challenges compared to 47, XXY. Developmental delays are often present in the first 3 years of life in the areas of speech and motor development. Overall cognitive abilities tend to be in the borderline range (IQ of 70 – 80) with approximately 1/3 of males with 48, XXYY with full scale IQ in the intellectual disability range (<70). Cognitive profiles often show significantly lower verbal reasoning skills compared to nonverbal and visual-spatial skills (which are often areas of strength). Language disorders and learning disabilities (especially with reading) are very common. Adaptive functioning (life skills) also commonly show deficits in communication, social skills, self-care and self-direction. Motor coordination deficits are also common. Behavioral characteristics can include executive function impairments, difficulties with attention, impulsivity and hyperactivity. Attention-deficit/hyperactivity disorder (ADHD) is often diagnosed. Mood instability, short frustration tolerance, anxiety, compulsive behaviors and emotional immaturity are also characteristic of 48, XXYY. Additional features can include nail biting, sugar cravings and intense interests. There is increased risk for social difficulties, including difficulties in social skills, reciprocal social interactions and insight into social relationships. As a result, there is an increased risk for an autism spectrum disorder (ASD) diagnosis, and approximately half of males with 48, XXYY met DSM-5 criteria for ASD in a research study. Common strengths include artistic skills, computer skills and navigation skills.",
]

class EmbedDiseaseSymptoms:
    def __init__(self) -> None:
        self.model = INSTRUCTOR('hkunlp/instructor-base')
        self.max_len = self.model.max_seq_length


    def chunk_sentence(self, sentence: str, overlap=384):
        tokenized = self.model[0].tokenizer(sentence).input_ids

        tokenized_substrings = []
        while len(tokenized) > self.max_len:
            tokenized_substrings.append(tokenized[:self.max_len])
            tokenized = tokenized[self.max_len - overlap:]

        tokenized_substrings.append(tokenized[:-1])

        sentences = [self.model[0].tokenizer.decode(token_substring) for token_substring in tokenized_substrings]

        return sentences

    def encode_document(self, document):
        sentences = self.chunk_sentence(document)

        encodings = []
        for sentence in sentences:
            encodings.append(self.model.encode([['Represent the Medicine document for retrieval',sentence]])[0])

        return encodings

    def encode_query(self, query):
        sentences = self.chunk_sentence(query)

        encodings = []
        for sentence in sentences:
            encodings.append(self.model.encode([['Represent the Medicine document for retrieving supporting documents',sentence]])[0])

        return encodings


if __name__ == '__main__':
    embedder = EmbedDiseaseSymptoms()

    query = embedder.encode_query('Patient is young, failing to thrive, and has many teeth growing at a fast rate, what is this?, keywords: macrodontia, prognathism, hyperkeratosis, hyperpigmentation, acanthosis nigricans')
    for document in documents:
        doc_embedding = embedder.encode_document(document)
        doc_avg = np.average(doc_embedding, axis=0,keepdims=True)
        print('Cosine Similarity for document fragments', cosine_similarity(query, doc_embedding))
        print('Cosine Similarity for document average', cosine_similarity(query, doc_avg))

